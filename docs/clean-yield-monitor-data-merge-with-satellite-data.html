<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Clean yield monitor data &amp; merge with satellite data | Spatio-temporal yield variation to precipitation within a field</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Clean yield monitor data &amp; merge with satellite data | Spatio-temporal yield variation to precipitation within a field" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Clean yield monitor data &amp; merge with satellite data | Spatio-temporal yield variation to precipitation within a field" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Emmanuela van Versendaal" />


<meta name="date" content="2024-08-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="retrieve-satellite-data.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="body {
  font-family: Arial, sans-serif;
  font-size: 10pt;
  text-align: justify;
}
p {
  text-align: justify;
}" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<Spatio-temporal Yield variation within field>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html"><i class="fa fa-check"></i><b>2</b> Retrieve satellite data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html#import-and-configurate-libraries"><i class="fa fa-check"></i><b>2.1</b> Import and configurate libraries</a></li>
<li class="chapter" data-level="2.2" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html#field-identification"><i class="fa fa-check"></i><b>2.2</b> Field identification</a></li>
<li class="chapter" data-level="2.3" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html#gcvi-peak-detection"><i class="fa fa-check"></i><b>2.3</b> GCVI Peak detection</a></li>
<li class="chapter" data-level="2.4" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html#gcvi-at-pixel-level-within-field"><i class="fa fa-check"></i><b>2.4</b> GCVI at pixel level within field</a></li>
<li class="chapter" data-level="2.5" data-path="retrieve-satellite-data.html"><a href="retrieve-satellite-data.html#reference"><i class="fa fa-check"></i><b>2.5</b> Reference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="clean-yield-monitor-data-merge-with-satellite-data.html"><a href="clean-yield-monitor-data-merge-with-satellite-data.html"><i class="fa fa-check"></i><b>3</b> Clean yield monitor data &amp; merge with satellite data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="clean-yield-monitor-data-merge-with-satellite-data.html"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#import-libraries"><i class="fa fa-check"></i><b>3.1</b> Import libraries</a></li>
<li class="chapter" data-level="3.2" data-path="clean-yield-monitor-data-merge-with-satellite-data.html"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#field-identification-1"><i class="fa fa-check"></i><b>3.2</b> Field identification</a></li>
<li class="chapter" data-level="3.3" data-path="clean-yield-monitor-data-merge-with-satellite-data.html"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#clean-yield-monitor-data"><i class="fa fa-check"></i><b>3.3</b> Clean yield monitor data</a></li>
<li class="chapter" data-level="3.4" data-path="clean-yield-monitor-data-merge-with-satellite-data.html"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#join-yield-monitor-data-gcvi-data-sentinel-data"><i class="fa fa-check"></i><b>3.4</b> Join yield monitor data &amp; GCVI data (Sentinel data)</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal yield variation to precipitation within a field</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="clean-yield-monitor-data-merge-with-satellite-data" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Clean yield monitor data &amp; merge with satellite data<a href="clean-yield-monitor-data-merge-with-satellite-data.html#clean-yield-monitor-data-merge-with-satellite-data" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The methodology to be used in this case for cleaning yield monitor maps is that used by Cordoba et al. (2009). This methodology consists of two steps: removing outliers and cleaning according to the Local Moran Method.</p>
<ol style="list-style-type: decimal">
<li><p>Delete outliers: This involves removing yield values that are more than three standard deviations above or below the mean. In this step, global outliers located at the extremes of the dataset are eliminated, but not local extremes (spatial outliers).</p></li>
<li><p>Local Moran: This step involves eliminating spatial outliers, also known as inliers, which are data points that significantly differ from their neighborhood but are within the general range of variation of the dataset. This inlier identification step is based on Anselin (1995) methodology, known as the local Moran’s spatial autocorrelation index. Given a group of data belonging to different neighborhoods, Local Moran is applied to each data point individually, indicating the degree of similarity or difference between the value of an observation and the values of its neighbors. To calculate the Moran’s Index, it is necessary to identify the neighborhood for each data point, which is the domain where there are data that can be interpreted as spatial neighbors and will be used as a reference to determine whether the data point is different from its neighbors.</p></li>
</ol>
<p>Source: <a href="https://www.researchgate.net/profile/Monica-Balzarini/publication/341282116_Guia_para_el_analisis_de_datos_espaciales_Aplicaciones_en_agricultura/links/5f4e253fa6fdcc14c505fedd/Guia-para-el-analisis-de-datos-espaciales-Aplicaciones-en-agricultura.pdf" class="uri">https://www.researchgate.net/profile/Monica-Balzarini/publication/341282116_Guia_para_el_analisis_de_datos_espaciales_Aplicaciones_en_agricultura/links/5f4e253fa6fdcc14c505fedd/Guia-para-el-analisis-de-datos-espaciales-Aplicaciones-en-agricultura.pdf</a>”</p>
<div id="import-libraries" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Import libraries<a href="clean-yield-monitor-data-merge-with-satellite-data.html#import-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-1" tabindex="-1"></a><span class="co"># Packages to be used</span></span>
<span id="cb12-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-2" tabindex="-1"></a>library_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>, <span class="co"># (Bivand et al., 2012)</span></span>
<span id="cb12-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-3" tabindex="-1"></a>                   <span class="st">&quot;sf&quot;</span>,  <span class="co"># (Pebesma, 2018)</span></span>
<span id="cb12-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-4" tabindex="-1"></a>                   <span class="st">&quot;spdep&quot;</span>, <span class="co"># local moran (Pebesma and Bivand, 2023)</span></span>
<span id="cb12-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-5" tabindex="-1"></a>                   <span class="st">&quot;gstat&quot;</span>, <span class="co"># grid and interpolation (Gräler et al., 2016)</span></span>
<span id="cb12-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-6" tabindex="-1"></a>                   <span class="st">&quot;raster&quot;</span>, <span class="co"># (Hijmans, 2023)</span></span>
<span id="cb12-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-7" tabindex="-1"></a>                   <span class="st">&quot;tidyverse&quot;</span>) <span class="co"># (Wickham et al., 2019)</span></span>
<span id="cb12-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-8" tabindex="-1"></a><span class="co"># Iterate over each library name</span></span>
<span id="cb12-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-9" tabindex="-1"></a><span class="cf">for</span> (lib_name <span class="cf">in</span> library_names) {</span>
<span id="cb12-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-10" tabindex="-1"></a>  <span class="co"># Check if the library is already installed</span></span>
<span id="cb12-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-11" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(lib_name, <span class="at">character.only =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-12" tabindex="-1"></a>    <span class="co"># If the library is not installed, install it</span></span>
<span id="cb12-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-13" tabindex="-1"></a>    <span class="fu">install.packages</span>(lib_name, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-14" tabindex="-1"></a>    <span class="co"># Load the library</span></span>
<span id="cb12-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-15" tabindex="-1"></a>    <span class="fu">library</span>(lib_name, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-16" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-17" tabindex="-1"></a>    <span class="co"># If the library is already installed, load it</span></span>
<span id="cb12-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-18" tabindex="-1"></a>    <span class="fu">library</span>(lib_name, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-19" tabindex="-1"></a>  }</span>
<span id="cb12-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb12-20" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="field-identification-1" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Field identification<a href="clean-yield-monitor-data-merge-with-satellite-data.html#field-identification-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Add the name of the field that you want to clean below. The code is all related to the name that you add there.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb13-1" tabindex="-1"></a>FIELD_TO_CLEAN <span class="ot">&lt;-</span> <span class="st">&quot;OH2&quot;</span></span></code></pre></div>
</div>
<div id="clean-yield-monitor-data" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Clean yield monitor data<a href="clean-yield-monitor-data-merge-with-satellite-data.html#clean-yield-monitor-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Obtain path to original Yield monitor data</strong></p>
<p>To automate the cleaning process, establish paths for: (i) each yield monitor data file that requires cleaning, and (ii) the field polygon. The field polygon will be used to cut the yield map, allowing for the exclusion of data collected when the harvesting machine is maneuvering around field borders and other problematic areas.</p>
<p>IMPORTANT:</p>
<p>After running the entire cleaning code, and maybe (could help to visualize) the data exploration code, check the yield distribution within the field. If there is strange patterns or some rows with completely different yields, check the data in QGIS to evaluate it there is any problem.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-1" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-2" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">list.files</span>(<span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/1_Original/&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;/Soybean&quot;</span>),</span>
<span id="cb14-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-3" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/1_Original/&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;/Maize&quot;</span>)), </span>
<span id="cb14-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-4" tabindex="-1"></a>                    <span class="at">full.names =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.shp&quot;</span>, <span class="at">recursive =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Polygon =</span><span class="fu">list.files</span>(<span class="st">&quot;1_Data/1_Polygon&quot;</span>, <span class="at">pattern =</span> <span class="fu">paste0</span>(FIELD_TO_CLEAN,<span class="st">&quot;_pol.shp&quot;</span>), </span>
<span id="cb14-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-6" tabindex="-1"></a>                             <span class="at">full.names =</span> T, <span class="at">recursive =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">path2=</span>path) <span class="sc">%&gt;%</span> </span>
<span id="cb14-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-8" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> path2, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;del_Datafold&quot;</span> ,<span class="st">&quot;del_YMfold&quot;</span>,<span class="st">&quot;del_Origfold&quot;</span> ,<span class="st">&quot;Field&quot;</span>,</span>
<span id="cb14-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-9" tabindex="-1"></a>                                  <span class="st">&quot;Crop&quot;</span>,  <span class="st">&quot;Farm_name&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-10" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> Farm_name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;Family&quot;</span>, <span class="st">&quot;del_Home&quot;</span>, <span class="st">&quot;del_field&quot;</span>, <span class="st">&quot;del_harvest&quot;</span>, <span class="st">&quot;Year&quot;</span>), </span>
<span id="cb14-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-11" tabindex="-1"></a>           <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-12" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*_(20</span><span class="sc">\\</span><span class="st">d{2})-.*</span><span class="sc">\\</span><span class="st">.shp&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, path)))<span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Year <span class="sc">&gt;</span><span class="dv">2015</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb14-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">&quot;del_&quot;</span>))) </span></code></pre></div>
<p><strong>1) Check data &amp; first step of cleaning process</strong></p>
<p>This code first generates yield maps before any cleaning process is applied. Next, it performs the initial step of the cleaning process by removing extreme outliers. This is done by filtering the data based on combine speed, grain moisture, and yield variables.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-1" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files)){</span>
<span id="cb15-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-2" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb15-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-3" tabindex="-1"></a>                     <span class="do">#### DATA CHECKING ####</span></span>
<span id="cb15-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-4" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb15-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-5" tabindex="-1"></a>  <span class="co"># Obtain yield monitor data</span></span>
<span id="cb15-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-6" tabindex="-1"></a>  YM <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(files[file,<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-7" tabindex="-1"></a>    <span class="fu">st_set_crs</span>(<span class="fu">st_crs</span>(<span class="st">&quot;epsg:4326&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-8" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">32616</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-9" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]),</span>
<span id="cb15-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-10" tabindex="-1"></a>                  <span class="at">Y =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb15-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-11" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Yield =</span> VRYIELDVOL,</span>
<span id="cb15-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-12" tabindex="-1"></a>           <span class="at">VEHICLSPEED =</span> <span class="fu">starts_with</span>(<span class="st">&quot;VEHICLSPE&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Moisture,WetMass,Yield, VEHICLSPEED,</span>
<span id="cb15-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-14" tabindex="-1"></a>                  DISTANCE)</span>
<span id="cb15-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-15" tabindex="-1"></a>  <span class="co"># Obtain Field polygon (boundary)</span></span>
<span id="cb15-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-16" tabindex="-1"></a>   pol <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(files[file,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb15-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-17" tabindex="-1"></a>     <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(YM)) </span>
<span id="cb15-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-18" tabindex="-1"></a>  <span class="co"># Clip the yield data with the field boundary</span></span>
<span id="cb15-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-19" tabindex="-1"></a>   YM <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(YM, pol)</span>
<span id="cb15-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-20" tabindex="-1"></a>  <span class="co"># Plot data to check original data</span></span>
<span id="cb15-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-21" tabindex="-1"></a>   YM_original <span class="ot">&lt;-</span> YM <span class="sc">%&gt;%</span> </span>
<span id="cb15-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-22" tabindex="-1"></a>     <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb15-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-23" tabindex="-1"></a>     <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Yield))<span class="sc">+</span></span>
<span id="cb15-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-24" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Yield (bu/ac)&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-25" tabindex="-1"></a>     <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&quot;#3b0001&quot;</span>,<span class="st">&quot;#be0003&quot;</span>,<span class="st">&quot;#ff4903&quot;</span>, <span class="st">&quot;#ffdc00&quot;</span>,<span class="st">&quot;#559d03&quot;</span>,<span class="st">&quot;#075e07&quot;</span>,<span class="st">&#39;#161f0c&#39;</span>))<span class="sc">+</span></span>
<span id="cb15-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-26" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb15-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-27" tabindex="-1"></a>           <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb15-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-28" tabindex="-1"></a>   <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;3_Output/2_YM_clean/1_Original/YM/&quot;</span>,</span>
<span id="cb15-29"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-29" tabindex="-1"></a>                 files[file,<span class="dv">3</span>],<span class="st">&quot;_&quot;</span>,files[file,<span class="dv">4</span>],files[file,<span class="dv">6</span>],<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb15-30"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-30" tabindex="-1"></a>          <span class="at">height =</span> <span class="dv">3</span>, <span class="at">width =</span> <span class="fl">6.5</span>)</span>
<span id="cb15-31"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-31" tabindex="-1"></a>   distr_pl <span class="ot">&lt;-</span> YM <span class="sc">%&gt;%</span> </span>
<span id="cb15-32"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-32" tabindex="-1"></a>     dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>FID) <span class="sc">%&gt;%</span> </span>
<span id="cb15-33"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-33" tabindex="-1"></a>     <span class="fu">pivot_longer</span>(<span class="sc">!</span>geometry, <span class="at">names_to =</span> <span class="st">&quot;Var&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Val&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-34"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-34" tabindex="-1"></a>     <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb15-35"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-35" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(Val), <span class="at">fill =</span> <span class="st">&quot;grey60&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey20&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-36"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-36" tabindex="-1"></a>     <span class="fu">facet_wrap</span>(<span class="sc">~</span>Var, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-37"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-37" tabindex="-1"></a>     <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb15-38"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-38" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Value&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-39"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-39" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span>
<span id="cb15-40"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-40" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;3_Output/2_YM_clean/1_Original/Distr/&quot;</span>,</span>
<span id="cb15-41"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-41" tabindex="-1"></a>                  files[file,<span class="dv">3</span>],<span class="st">&quot;_&quot;</span>,files[file,<span class="dv">4</span>],files[file,<span class="dv">6</span>],<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb15-42"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-42" tabindex="-1"></a>           <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="fl">2.5</span>)</span>
<span id="cb15-43"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-43" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb15-44"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-44" tabindex="-1"></a>                   <span class="do">#### DATA CLEANING: STEP 1 ####</span></span>
<span id="cb15-45"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-45" tabindex="-1"></a>  <span class="do">###########################################################    </span></span>
<span id="cb15-46"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-46" tabindex="-1"></a>    <span class="co"># 1) Remove general outliers (extreme outliers)</span></span>
<span id="cb15-47"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-47" tabindex="-1"></a>    YM_in <span class="ot">&lt;-</span> YM <span class="sc">%&gt;%</span> </span>
<span id="cb15-48"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(Yield<span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-49"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-49" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Speed_q025 =</span> <span class="fu">quantile</span>(VEHICLSPEED, <span class="fl">0.025</span>),</span>
<span id="cb15-50"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-50" tabindex="-1"></a>             <span class="at">Speed_q975 =</span> <span class="fu">quantile</span>(VEHICLSPEED, <span class="fl">0.975</span>),</span>
<span id="cb15-51"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-51" tabindex="-1"></a>             <span class="at">Moist_q025 =</span> <span class="fu">quantile</span>(Moisture, <span class="fl">0.025</span>),</span>
<span id="cb15-52"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-52" tabindex="-1"></a>             <span class="at">Moist_q975 =</span> <span class="fu">quantile</span>(Moisture, <span class="fl">0.975</span>),</span>
<span id="cb15-53"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-53" tabindex="-1"></a>             <span class="at">mean_yield =</span> <span class="fu">mean</span>(Yield),</span>
<span id="cb15-54"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-54" tabindex="-1"></a>             <span class="at">sd_yield =</span> <span class="fu">sd</span>(Yield),</span>
<span id="cb15-55"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-55" tabindex="-1"></a>             <span class="at">LI =</span> mean_yield<span class="dv">-3</span><span class="sc">*</span>sd_yield,</span>
<span id="cb15-56"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-56" tabindex="-1"></a>             <span class="at">LS =</span> mean_yield<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>sd_yield) <span class="sc">%&gt;%</span> </span>
<span id="cb15-57"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-57" tabindex="-1"></a>      <span class="co"># Filtering rules with clear physical meaning </span></span>
<span id="cb15-58"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-58" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(Yield<span class="sc">&gt;</span> LI <span class="sc">&amp;</span> Yield<span class="sc">&lt;</span> LS <span class="sc">&amp;</span> </span>
<span id="cb15-59"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-59" tabindex="-1"></a>                      VEHICLSPEED <span class="sc">&gt;</span>  Speed_q025 <span class="sc">&amp;</span> VEHICLSPEED <span class="sc">&lt;</span>Speed_q975<span class="sc">&amp;</span></span>
<span id="cb15-60"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-60" tabindex="-1"></a>                      Moisture <span class="sc">&gt;</span> Moist_q025 <span class="sc">&amp;</span> Moisture <span class="sc">&lt;</span> Moist_q975) </span>
<span id="cb15-61"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-61" tabindex="-1"></a>  </span>
<span id="cb15-62"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-62" tabindex="-1"></a>     sf<span class="sc">::</span><span class="fu">write_sf</span>(YM_in,<span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/2_Clean_Gener_Outliers/&quot;</span>,</span>
<span id="cb15-63"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-63" tabindex="-1"></a>                               FIELD_TO_CLEAN,<span class="st">&quot;_&quot;</span>,files[file,<span class="dv">4</span>],<span class="st">&quot;_&quot;</span>,files[file,<span class="dv">6</span>],<span class="st">&quot;.shp&quot;</span>),</span>
<span id="cb15-64"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-64" tabindex="-1"></a>                  <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-65"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-65" tabindex="-1"></a>     <span class="co"># Plot data with the first cleaning step</span></span>
<span id="cb15-66"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-66" tabindex="-1"></a>     YM_out <span class="ot">&lt;-</span> YM_in <span class="sc">%&gt;%</span> </span>
<span id="cb15-67"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-67" tabindex="-1"></a>       <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb15-68"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-68" tabindex="-1"></a>       <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Yield))<span class="sc">+</span></span>
<span id="cb15-69"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-69" tabindex="-1"></a>       <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Yield (bu/ac)&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-70"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-70" tabindex="-1"></a>       <span class="fu">scale_color_gradientn</span>(<span class="at">colors=</span><span class="fu">c</span>(<span class="st">&quot;#3b0001&quot;</span>,<span class="st">&quot;#be0003&quot;</span>,<span class="st">&quot;#ff4903&quot;</span>, <span class="st">&quot;#ffdc00&quot;</span>,<span class="st">&quot;#559d03&quot;</span>,<span class="st">&quot;#075e07&quot;</span>,<span class="st">&#39;#161f0c&#39;</span>))<span class="sc">+</span></span>
<span id="cb15-71"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-71" tabindex="-1"></a>       <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb15-72"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-72" tabindex="-1"></a>           <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb15-73"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-73" tabindex="-1"></a>  </span>
<span id="cb15-74"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-74" tabindex="-1"></a>     <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;3_Output/2_YM_clean/2_General_Outliers/&quot;</span>,</span>
<span id="cb15-75"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-75" tabindex="-1"></a>                   files[file,<span class="dv">3</span>],<span class="st">&quot;_&quot;</span>,files[file,<span class="dv">4</span>],files[file,<span class="dv">6</span>],<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb15-76"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-76" tabindex="-1"></a>            <span class="at">height =</span> <span class="dv">3</span>, <span class="at">width =</span> <span class="fl">6.5</span>)</span>
<span id="cb15-77"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-77" tabindex="-1"></a>}</span>
<span id="cb15-78"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb15-78" tabindex="-1"></a>YM_original <span class="co"># Original data without removing general outliers</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb16-1" tabindex="-1"></a>YM_out <span class="co"># Yield monitor data without general outliers</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
<p><strong>Path to Yield monitor without extreme/general outliers</strong></p>
<p>Upload the paths to the yield monitor data shapefiles after removing extreme outliers. Additionally, create a 10 m x 10 m grid for the farm to match the cell/pixel size of the Sentinel data.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-1" tabindex="-1"></a>files2 <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">path=</span><span class="fu">list.files</span>(<span class="st">&quot;1_Data/3_YM/2_Clean_Gener_Outliers&quot;</span>, </span>
<span id="cb17-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-2" tabindex="-1"></a>                                    <span class="at">full.names =</span> T,<span class="at">pattern =</span> <span class="st">&quot;.shp&quot;</span>,<span class="at">recursive =</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(path, FIELD_TO_CLEAN)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Polygon =</span> <span class="fu">as.vector</span>(<span class="fu">list.files</span>(<span class="st">&quot;1_Data/1_Polygon&quot;</span>, </span>
<span id="cb17-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-5" tabindex="-1"></a>                                        <span class="at">full.names =</span> T,</span>
<span id="cb17-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-6" tabindex="-1"></a>                                        <span class="at">pattern =</span> <span class="fu">paste0</span>(FIELD_TO_CLEAN,<span class="st">&quot;_pol.shp&quot;</span>), </span>
<span id="cb17-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-7" tabindex="-1"></a>                                        <span class="at">recursive =</span> T)),</span>
<span id="cb17-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-8" tabindex="-1"></a>         <span class="at">path2=</span>path) <span class="sc">%&gt;%</span> </span>
<span id="cb17-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">path2 =</span> <span class="fu">str_remove</span>(path2,<span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/2_Clean_Gener_Outliers/&quot;</span>,</span>
<span id="cb17-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-10" tabindex="-1"></a>                                         FIELD_TO_CLEAN,<span class="st">&quot;_&quot;</span>)),</span>
<span id="cb17-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-11" tabindex="-1"></a>         <span class="at">Field =</span> FIELD_TO_CLEAN) <span class="sc">%&gt;%</span> </span>
<span id="cb17-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-12" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> path2, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;Crop&quot;</span>, <span class="st">&quot;Year&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-13" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">str_remove</span>(Year, <span class="st">&quot;.shp&quot;</span>))</span>
<span id="cb17-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-15" tabindex="-1"></a><span class="co"># This part is to obtain the field boundaries </span></span>
<span id="cb17-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-16" tabindex="-1"></a>YM <span class="ot">&lt;-</span> YM_in<span class="sc">%&gt;%</span> </span>
<span id="cb17-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]),</span>
<span id="cb17-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-18" tabindex="-1"></a>                  <span class="at">Y =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb17-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y,Yield) <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-20" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-21" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb17-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-22" tabindex="-1"></a>  </span>
<span id="cb17-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-23" tabindex="-1"></a>  <span class="fu">names</span>(YM)       <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>,<span class="st">&quot;Yield&quot;</span>)</span>
<span id="cb17-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-24" tabindex="-1"></a>  <span class="fu">coordinates</span>(YM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb17-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-25" tabindex="-1"></a>  <span class="fu">proj4string</span>(YM) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs&quot;</span>)</span>
<span id="cb17-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-26" tabindex="-1"></a></span>
<span id="cb17-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-27" tabindex="-1"></a>grd <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="fu">min</span>(<span class="fu">as.data.frame</span>(YM)[,<span class="dv">1</span>]), </span>
<span id="cb17-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-28" tabindex="-1"></a>                           <span class="fu">max</span>(<span class="fu">as.data.frame</span>(YM)[,<span class="dv">1</span>]), <span class="at">by=</span><span class="dv">10</span>),</span>
<span id="cb17-29"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-29" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">seq</span>(<span class="fu">min</span>(<span class="fu">as.data.frame</span>(YM)[,<span class="dv">2</span>]),</span>
<span id="cb17-30"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-30" tabindex="-1"></a>                           <span class="fu">max</span>(<span class="fu">as.data.frame</span>(YM)[,<span class="dv">2</span>]), <span class="at">by=</span><span class="dv">10</span>))</span>
<span id="cb17-31"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-31" tabindex="-1"></a><span class="fu">names</span>(grd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>,<span class="st">&quot;Y&quot;</span>)</span>
<span id="cb17-32"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-32" tabindex="-1"></a><span class="fu">coordinates</span>(grd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>,<span class="st">&quot;Y&quot;</span>)</span>
<span id="cb17-33"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-33" tabindex="-1"></a><span class="fu">proj4string</span>(grd) <span class="ot">&lt;-</span><span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs&quot;</span>)</span>
<span id="cb17-34"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-34" tabindex="-1"></a><span class="fu">gridded</span>(grd) <span class="ot">&lt;-</span> <span class="cn">TRUE</span>  <span class="co"># Create SpatialPixel object</span></span>
<span id="cb17-35"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb17-35" tabindex="-1"></a><span class="fu">fullgrid</span>(grd) <span class="ot">&lt;-</span> <span class="cn">TRUE</span>  <span class="co"># Create SpatialGrid object</span></span></code></pre></div>
<p><strong>2) Second step of cleaning yield monitor data: Local Moran</strong></p>
<p>Second step of the data cleaning process: The Local Moran method was used to identify and remove inliers and spatial outliers from the dataset. Additionally, yield monitor data were interpolated using inverse distance weighting (IDW) interpolation (Gräler et al., 2016) to generate a 10x10 m grid. This grid resolution allows for the consistent overlay of yield monitor data across multiple years and aligns with the resolution of Sentinel data.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-1" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files2)){</span>
<span id="cb18-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-2" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb18-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-3" tabindex="-1"></a>                   <span class="do">#### DATA CLEANING: STEP 2 ####</span></span>
<span id="cb18-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-4" tabindex="-1"></a>  <span class="do">###########################################################  </span></span>
<span id="cb18-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-5" tabindex="-1"></a>  <span class="co"># Upload dataframe without extreme values</span></span>
<span id="cb18-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-6" tabindex="-1"></a>  YM_in <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(files2[file,<span class="dv">1</span>]) </span>
<span id="cb18-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-7" tabindex="-1"></a>  <span class="do">## LOCAL MORAN CLEANING METHOD ##</span></span>
<span id="cb18-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-8" tabindex="-1"></a>  NB <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(YM_in<span class="sc">$</span>geometry, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">18</span>)</span>
<span id="cb18-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-9" tabindex="-1"></a>  <span class="co">#summary(NB)</span></span>
<span id="cb18-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-10" tabindex="-1"></a>  moranl <span class="ot">&lt;-</span><span class="fu">localmoran</span>(YM_in<span class="sc">$</span>Yield, </span>
<span id="cb18-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-11" tabindex="-1"></a>                      <span class="fu">nb2listw</span>(NB,<span class="at">style =</span> <span class="st">&quot;W&quot;</span>),</span>
<span id="cb18-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-12" tabindex="-1"></a>                      <span class="at">alternative =</span> <span class="st">&quot;less&quot;</span>)</span>
<span id="cb18-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-13" tabindex="-1"></a>  moranp <span class="ot">&lt;-</span> <span class="fu">moran.plot</span>(YM_in<span class="sc">$</span>Yield,</span>
<span id="cb18-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-14" tabindex="-1"></a>                       <span class="at">col =</span> <span class="dv">3</span>,</span>
<span id="cb18-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-15" tabindex="-1"></a>                       <span class="fu">nb2listw</span>(NB,<span class="at">style =</span> <span class="st">&quot;W&quot;</span>),</span>
<span id="cb18-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-16" tabindex="-1"></a>                       <span class="at">labels =</span> F,<span class="at">quiet =</span> T,</span>
<span id="cb18-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-17" tabindex="-1"></a>                       <span class="at">xlab =</span> <span class="st">&quot;Rinde&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Rinde Spatially Lagged&quot;</span>)</span>
<span id="cb18-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-18" tabindex="-1"></a>  <span class="co">#summary(moranp)</span></span>
<span id="cb18-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-19" tabindex="-1"></a>  influ <span class="ot">&lt;-</span> moranp<span class="sc">$</span>is_inf</span>
<span id="cb18-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-20" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(YM_in, moranl, influ)</span>
<span id="cb18-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-21" tabindex="-1"></a>  </span>
<span id="cb18-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-22" tabindex="-1"></a>  <span class="co"># Obtain dataset without extreme and spatial outliers</span></span>
<span id="cb18-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-23" tabindex="-1"></a>  YM_clean <span class="ot">&lt;-</span><span class="fu">subset</span>(data, data[[<span class="st">&quot;Ii&quot;</span>]] <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">|</span> data[[<span class="st">&quot;Pr.z...E.Ii..&quot;</span>]] <span class="sc">&gt;</span> <span class="fl">0.05</span>)</span>
<span id="cb18-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-24" tabindex="-1"></a>  inliers_ml <span class="ot">&lt;-</span><span class="fu">subset</span>(data, data[[<span class="st">&quot;Ii&quot;</span>]] <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> data[[<span class="st">&quot;Pr.z...E.Ii..&quot;</span>]] <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb18-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-25" tabindex="-1"></a>  </span>
<span id="cb18-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-26" tabindex="-1"></a>  <span class="co"># Plot to check data</span></span>
<span id="cb18-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-27" tabindex="-1"></a>  YM_clean_pl <span class="ot">&lt;-</span> YM_clean <span class="sc">%&gt;%</span> </span>
<span id="cb18-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-28" tabindex="-1"></a>    <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb18-29"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-29" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Yield))<span class="sc">+</span></span>
<span id="cb18-30"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-30" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Yield (bu/ac)&quot;</span>)<span class="sc">+</span></span>
<span id="cb18-31"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-31" tabindex="-1"></a>    <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&quot;#3b0001&quot;</span>,<span class="st">&quot;#be0003&quot;</span>,<span class="st">&quot;#ff4903&quot;</span>,</span>
<span id="cb18-32"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-32" tabindex="-1"></a>                                     <span class="st">&quot;#ffdc00&quot;</span>,<span class="st">&quot;#559d03&quot;</span>,<span class="st">&quot;#075e07&quot;</span>,<span class="st">&#39;#161f0c&#39;</span>))<span class="sc">+</span></span>
<span id="cb18-33"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-33" tabindex="-1"></a>       <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb18-34"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-34" tabindex="-1"></a>           <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb18-35"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-35" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;3_Output/2_YM_clean/3_Local_Moran/&quot;</span>,</span>
<span id="cb18-36"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-36" tabindex="-1"></a>                files2[file,<span class="dv">5</span>],<span class="st">&quot;_&quot;</span>,files2[file,<span class="dv">3</span>],files2[file,<span class="dv">4</span>],<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb18-37"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-37" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">3</span>, <span class="at">width =</span> <span class="fl">6.5</span>)</span>
<span id="cb18-38"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-38" tabindex="-1"></a></span>
<span id="cb18-39"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-39" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb18-40"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-40" tabindex="-1"></a>             <span class="do">#### CREATE GRID &amp; INTERPOLATE ####</span></span>
<span id="cb18-41"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-41" tabindex="-1"></a>  <span class="do">###########################################################    </span></span>
<span id="cb18-42"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-42" tabindex="-1"></a>  <span class="co"># Yield data</span></span>
<span id="cb18-43"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-43" tabindex="-1"></a>  YM <span class="ot">&lt;-</span> YM_clean <span class="sc">%&gt;%</span> </span>
<span id="cb18-44"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-44" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]),</span>
<span id="cb18-45"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-45" tabindex="-1"></a>                  <span class="at">Y =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb18-46"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-46" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y,Yield) <span class="sc">%&gt;%</span></span>
<span id="cb18-47"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-47" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-48"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-48" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb18-49"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-49" tabindex="-1"></a>  </span>
<span id="cb18-50"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-50" tabindex="-1"></a>  <span class="fu">names</span>(YM)       <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>,<span class="st">&quot;Yield&quot;</span>)</span>
<span id="cb18-51"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-51" tabindex="-1"></a>  <span class="fu">coordinates</span>(YM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb18-52"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-52" tabindex="-1"></a>  <span class="fu">proj4string</span>(YM) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs&quot;</span>)</span>
<span id="cb18-53"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-53" tabindex="-1"></a>  </span>
<span id="cb18-54"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-54" tabindex="-1"></a>  <span class="co"># Create grid using the field polygon</span></span>
<span id="cb18-55"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-55" tabindex="-1"></a>  pol <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(files2[file,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb18-56"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-56" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(YM))</span>
<span id="cb18-57"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-57" tabindex="-1"></a>  </span>
<span id="cb18-58"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-58" tabindex="-1"></a>  <span class="co"># Interpolation</span></span>
<span id="cb18-59"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-59" tabindex="-1"></a>  idw <span class="ot">&lt;-</span> <span class="fu">idw</span>(<span class="at">formula =</span> YM<span class="sc">$</span>Yield<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb18-60"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-60" tabindex="-1"></a>             <span class="at">locations =</span> YM, <span class="at">newdata =</span> grd,</span>
<span id="cb18-61"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-61" tabindex="-1"></a>             <span class="at">idp =</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-62"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-62" tabindex="-1"></a>    raster<span class="sc">::</span><span class="fu">raster</span>()</span>
<span id="cb18-63"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-63" tabindex="-1"></a>  </span>
<span id="cb18-64"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-64" tabindex="-1"></a>  idw <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">mask</span>(idw, pol)</span>
<span id="cb18-65"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-65" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">writeRaster</span>(idw, <span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/3_Interp_Grid/&quot;</span>,</span>
<span id="cb18-66"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-66" tabindex="-1"></a>                                   files2[file,<span class="dv">5</span>],<span class="st">&quot;_&quot;</span>,files2[file,<span class="dv">3</span>],files2[file,<span class="dv">4</span>],</span>
<span id="cb18-67"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-67" tabindex="-1"></a>                                  <span class="st">&quot;.tif&quot;</span>), <span class="at">overwrite =</span> T)</span>
<span id="cb18-68"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb18-68" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-17-1.png" width="672" /><img src="_main_files/figure-html/unnamed-chunk-17-2.png" width="672" /></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb19-1" tabindex="-1"></a>YM_clean_pl <span class="co"># Yield monitor data cleaned</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-17-3.png" width="672" /></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb20-1" tabindex="-1"></a>mapview<span class="sc">::</span><span class="fu">mapview</span>(idw) <span class="co"># Yield monitor data interpolateed &amp; gridded</span></span></code></pre></div>
<p><strong>3) Join all years of yield monitor data</strong></p>
<p>Up to this point, we have separate shapefiles for each year and field. In this code, we are merging all the yearly shapefiles (containing the cleaned yield monitor data) for each field into a single shapefile.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-1" tabindex="-1"></a><span class="co"># Generate a dataframe with paths and metadata</span></span>
<span id="cb21-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-2" tabindex="-1"></a>raster_paths <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">path =</span> <span class="fu">list.files</span>(<span class="st">&quot;1_Data/3_YM/3_Interp_Grid/&quot;</span>, </span>
<span id="cb21-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-3" tabindex="-1"></a>                                             <span class="at">full.names =</span> T,<span class="at">recursive =</span> T, </span>
<span id="cb21-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-4" tabindex="-1"></a>                                             <span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif$&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(path, FIELD_TO_CLEAN)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(path),</span>
<span id="cb21-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-7" tabindex="-1"></a>         <span class="at">filename =</span> <span class="fu">str_remove</span>(filename, <span class="fu">paste0</span>(FIELD_TO_CLEAN,<span class="st">&quot;_&quot;</span>)),</span>
<span id="cb21-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-8" tabindex="-1"></a>         <span class="at">filename =</span> <span class="fu">str_remove</span>(filename, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif$&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-9" tabindex="-1"></a>  <span class="fu">separate</span>(filename,<span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;Crop&quot;</span>,<span class="st">&quot;Year&quot;</span>),<span class="at">sep =</span><span class="st">&quot;(?&lt;=[A-Za-z])(?=[0-9])&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-10" tabindex="-1"></a>  <span class="fu">arrange</span>(Crop, Year)</span>
<span id="cb21-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-11" tabindex="-1"></a></span>
<span id="cb21-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-12" tabindex="-1"></a><span class="co"># Function to load raster</span></span>
<span id="cb21-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-13" tabindex="-1"></a>read_rasters <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb21-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-14" tabindex="-1"></a>  <span class="fu">raster</span>(x)</span>
<span id="cb21-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-15" tabindex="-1"></a>}</span>
<span id="cb21-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-16" tabindex="-1"></a></span>
<span id="cb21-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-17" tabindex="-1"></a><span class="co"># Read and stack rasters</span></span>
<span id="cb21-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-18" tabindex="-1"></a>raster_stack <span class="ot">&lt;-</span> raster_paths<span class="sc">$</span>path <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-19" tabindex="-1"></a>  <span class="fu">map</span>(read_rasters) <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-20" tabindex="-1"></a>  <span class="fu">stack</span>()</span>
<span id="cb21-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-21" tabindex="-1"></a></span>
<span id="cb21-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-22" tabindex="-1"></a>YM_final <span class="ot">&lt;-</span> <span class="fu">rasterToPoints</span>(raster_stack, <span class="at">spatial=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-23" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-24" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span>geometry, <span class="at">names_to =</span> <span class="st">&quot;CropYear&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Yield&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-25" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CropYear =</span> <span class="fu">str_remove</span>(CropYear, <span class="fu">paste0</span>(FIELD_TO_CLEAN,<span class="st">&quot;_&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb21-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-26" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">32616</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]),</span>
<span id="cb21-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-28" tabindex="-1"></a>                <span class="at">Y =</span> <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb21-29"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-29" tabindex="-1"></a>  <span class="fu">separate</span>(CropYear, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;Crop&quot;</span>, <span class="st">&quot;Year&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;(?&lt;=[A-Za-z])(?=[0-9])&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-30"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-30" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">as.numeric</span>(Year))</span>
<span id="cb21-31"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-31" tabindex="-1"></a></span>
<span id="cb21-32"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb21-32" tabindex="-1"></a><span class="fu">write_sf</span>(YM_final,<span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/4_YM_final/YM_&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;.shp&quot;</span>))</span></code></pre></div>
</div>
<div id="join-yield-monitor-data-gcvi-data-sentinel-data" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Join yield monitor data &amp; GCVI data (Sentinel data)<a href="clean-yield-monitor-data-merge-with-satellite-data.html#join-yield-monitor-data-gcvi-data-sentinel-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Path to rasters and clean yield monitor data</strong></p>
<p>Obtain the file paths for each field image where the GCVI has already been calculated. These images correspond to three key moments: the peak, 30 days before the peak (Peak_b3), and 30 days after the peak (Peak_30).</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-1" tabindex="-1"></a>vi_path <span class="ot">&lt;-</span></span>
<span id="cb22-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-2" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">path =</span><span class="fu">list.files</span>(<span class="fu">c</span>(<span class="st">&quot;1_Data/2_Spatial_Layer/2_VI_raster/Peak_b3/&quot;</span>,</span>
<span id="cb22-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-3" tabindex="-1"></a>                                <span class="st">&quot;1_Data/2_Spatial_Layer/2_VI_raster/Peak/&quot;</span>,</span>
<span id="cb22-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-4" tabindex="-1"></a>                                <span class="st">&quot;1_Data/2_Spatial_Layer/2_VI_raster/Peak_30/&quot;</span>),</span>
<span id="cb22-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-5" tabindex="-1"></a>                              <span class="at">full.names=</span>T, <span class="at">pattern=</span> <span class="st">&quot;.tif&quot;</span>, <span class="at">recursive =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">YM_path =</span><span class="fu">list.files</span>(<span class="st">&quot;1_Data/3_YM/4_YM_final&quot;</span>,</span>
<span id="cb22-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-7" tabindex="-1"></a>                             <span class="at">full.names=</span>T,<span class="at">recursive =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-8" tabindex="-1"></a>                             <span class="at">pattern=</span><span class="fu">paste0</span>(FIELD_TO_CLEAN,<span class="st">&quot;.shp&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb22-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*_(20</span><span class="sc">\\</span><span class="st">d{2})_.*</span><span class="sc">\\</span><span class="st">.tif&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, path),</span>
<span id="cb22-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-10" tabindex="-1"></a>         <span class="at">Moment =</span> <span class="fu">str_extract</span>(path, <span class="st">&quot;(?&lt;=2_VI_raster/)[^/]+(?=/)&quot;</span>),</span>
<span id="cb22-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-11" tabindex="-1"></a>         <span class="at">VI =</span> <span class="fu">str_extract</span>(path, <span class="st">&quot;(NDVI|EVI|GCVI)&quot;</span>),</span>
<span id="cb22-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-12" tabindex="-1"></a>         <span class="at">VI_moment =</span> <span class="fu">paste</span>(Moment,VI,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(path, FIELD_TO_CLEAN)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-14" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Year, <span class="at">values_from =</span> path) <span class="sc">%&gt;%</span> </span>
<span id="cb22-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb22-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(VI <span class="sc">==</span> <span class="st">&quot;GCVI&quot;</span>)</span></code></pre></div>
<p><strong>Join all rasters to a dataframe</strong></p>
<p>Overlay all the rasters containing GCVI data for the field and clip them using the field boundary. Additionally, extract the relevant information from the rasters.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-1" tabindex="-1"></a>VImoments <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">unique</span>(vi_path<span class="sc">$</span>VI_moment))</span>
<span id="cb23-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-2" tabindex="-1"></a><span class="cf">for</span> (VIm <span class="cf">in</span> VImoments) {</span>
<span id="cb23-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-3" tabindex="-1"></a>  viPath <span class="ot">&lt;-</span> vi_path <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(VI_moment <span class="sc">==</span> VIm)</span>
<span id="cb23-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-4" tabindex="-1"></a>  </span>
<span id="cb23-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-5" tabindex="-1"></a>  YM <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(viPath[<span class="dv">1</span>][[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb23-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-6" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="st">&quot;epsg:4326&quot;</span>)</span>
<span id="cb23-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-7" tabindex="-1"></a>  points <span class="ot">&lt;-</span> YM <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>()</span>
<span id="cb23-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-8" tabindex="-1"></a>  </span>
<span id="cb23-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-9" tabindex="-1"></a>  str_crs <span class="ot">&lt;-</span> <span class="st">&quot;+init=epsg:4326&quot;</span> </span>
<span id="cb23-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-10" tabindex="-1"></a>  </span>
<span id="cb23-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-11" tabindex="-1"></a>  y17 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">5</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-12" tabindex="-1"></a>  <span class="fu">crs</span>(y17) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-13" tabindex="-1"></a>  <span class="fu">names</span>(y17) <span class="ot">&lt;-</span> <span class="st">&quot;2017&quot;</span></span>
<span id="cb23-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-14" tabindex="-1"></a></span>
<span id="cb23-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-15" tabindex="-1"></a>  y18 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">6</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-16" tabindex="-1"></a>  <span class="fu">crs</span>(y18) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-17" tabindex="-1"></a>  <span class="fu">names</span>(y18) <span class="ot">&lt;-</span> <span class="st">&quot;2018&quot;</span></span>
<span id="cb23-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-18" tabindex="-1"></a></span>
<span id="cb23-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-19" tabindex="-1"></a>  y19 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">7</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-20" tabindex="-1"></a>  <span class="fu">crs</span>(y19) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-21" tabindex="-1"></a>  <span class="fu">names</span>(y19) <span class="ot">&lt;-</span> <span class="st">&quot;2019&quot;</span></span>
<span id="cb23-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-22" tabindex="-1"></a></span>
<span id="cb23-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-23" tabindex="-1"></a>  y20 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">8</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-24" tabindex="-1"></a>  <span class="fu">crs</span>(y20) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-25" tabindex="-1"></a>  <span class="fu">names</span>(y20) <span class="ot">&lt;-</span> <span class="st">&quot;2020&quot;</span></span>
<span id="cb23-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-26" tabindex="-1"></a>  </span>
<span id="cb23-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-27" tabindex="-1"></a>  y21 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">9</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-28" tabindex="-1"></a>  <span class="fu">crs</span>(y21) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-29"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-29" tabindex="-1"></a>  <span class="fu">names</span>(y21) <span class="ot">&lt;-</span> <span class="st">&quot;2021&quot;</span></span>
<span id="cb23-30"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-30" tabindex="-1"></a>  </span>
<span id="cb23-31"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-31" tabindex="-1"></a>  y22 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">10</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-32"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-32" tabindex="-1"></a>  <span class="fu">crs</span>(y22) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-33"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-33" tabindex="-1"></a>  <span class="fu">names</span>(y22) <span class="ot">&lt;-</span> <span class="st">&quot;2022&quot;</span></span>
<span id="cb23-34"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-34" tabindex="-1"></a>  </span>
<span id="cb23-35"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-35" tabindex="-1"></a>  y23 <span class="ot">&lt;-</span><span class="fu">raster</span>(viPath[<span class="dv">11</span>][[<span class="dv">1</span>]])</span>
<span id="cb23-36"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-36" tabindex="-1"></a>  <span class="fu">crs</span>(y23) <span class="ot">&lt;-</span> str_crs</span>
<span id="cb23-37"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-37" tabindex="-1"></a>  <span class="fu">names</span>(y23) <span class="ot">&lt;-</span> <span class="st">&quot;2023&quot;</span></span>
<span id="cb23-38"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-38" tabindex="-1"></a>  </span>
<span id="cb23-39"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-39" tabindex="-1"></a>  <span class="do">## Stack/overlap the layers</span></span>
<span id="cb23-40"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-40" tabindex="-1"></a>  layers_stacked <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(y17,y18,y19,y20,y21,y22,y23)</span>
<span id="cb23-41"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-41" tabindex="-1"></a></span>
<span id="cb23-42"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-42" tabindex="-1"></a>  data_extracted <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">extract</span>(layers_stacked, points, </span>
<span id="cb23-43"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-43" tabindex="-1"></a>                                    <span class="at">fun=</span><span class="st">&#39;median&#39;</span>, <span class="at">df=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-44"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-44" tabindex="-1"></a>      tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;Iden&quot;</span>)</span>
<span id="cb23-45"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-45" tabindex="-1"></a>  </span>
<span id="cb23-46"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-46" tabindex="-1"></a>  merge <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(points, data_extracted) <span class="sc">%&gt;%</span></span>
<span id="cb23-47"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-47" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-48"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-48" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-49"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-49" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">&quot;X20&quot;</span>),<span class="at">names_to =</span> <span class="st">&quot;year_VI&quot;</span>, <span class="at">values_to =</span> VIm) <span class="sc">%&gt;%</span> </span>
<span id="cb23-50"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-50" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year_VI =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year_VI, <span class="st">&quot;X&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-51"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-51" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(Year <span class="sc">==</span> year_VI) <span class="sc">%&gt;%</span> </span>
<span id="cb23-52"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-52" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Crop, Year, Yield, <span class="fu">starts_with</span>(VIm),geometry)</span>
<span id="cb23-53"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-53" tabindex="-1"></a>  </span>
<span id="cb23-54"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-54" tabindex="-1"></a>  <span class="fu">write_sf</span>(merge,<span class="fu">paste0</span>(<span class="st">&quot;1_Data/2_Spatial_Layer/4_VI_YM/&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;_&quot;</span>,VIm,<span class="st">&quot;.shp&quot;</span>))</span>
<span id="cb23-55"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb23-55" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Join yield monitor data and GCVI data</strong></p>
<p>Merge the satellite data (GCVI at the peak, 30 days before, and 30 days after) with the yield monitor data across multiple years.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-1" tabindex="-1"></a><span class="co"># Base directory and field specifics</span></span>
<span id="cb24-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-2" tabindex="-1"></a>base_dir <span class="ot">&lt;-</span> <span class="st">&quot;1_Data/2_Spatial_Layer/4_VI_YM/&quot;</span></span>
<span id="cb24-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-3" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="st">&quot;GCVI&quot;</span></span>
<span id="cb24-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-4" tabindex="-1"></a>moments <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;_b3&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="st">&quot;_30&quot;</span>)</span>
<span id="cb24-5"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-5" tabindex="-1"></a></span>
<span id="cb24-6"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-6" tabindex="-1"></a><span class="co"># Initial data load and filtering</span></span>
<span id="cb24-7"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-7" tabindex="-1"></a>main_data <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="fu">paste0</span>(<span class="st">&quot;1_Data/3_YM/4_YM_final/YM_&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;.shp&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-8" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">&gt;</span> <span class="dv">2016</span>)</span>
<span id="cb24-9"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-10" tabindex="-1"></a><span class="co"># Loop over moments and indices</span></span>
<span id="cb24-11"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-11" tabindex="-1"></a><span class="cf">for</span> (moment <span class="cf">in</span> moments) {</span>
<span id="cb24-12"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-12" tabindex="-1"></a>  <span class="cf">for</span> (vi <span class="cf">in</span> indices) {</span>
<span id="cb24-13"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-13" tabindex="-1"></a>    file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_dir, FIELD_TO_CLEAN, <span class="st">&quot;_Peak&quot;</span>, moment, <span class="st">&quot;_&quot;</span>, vi, <span class="st">&quot;.shp&quot;</span>)</span>
<span id="cb24-14"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-14" tabindex="-1"></a>    shape_data <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(file_path) <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-15" tabindex="-1"></a>      <span class="fu">st_set_crs</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-16"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-16" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">as.numeric</span>(<span class="fu">st_coordinates</span>(.)[, <span class="dv">1</span>]),</span>
<span id="cb24-17"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-17" tabindex="-1"></a>             <span class="at">Y =</span> <span class="fu">as.numeric</span>(<span class="fu">st_coordinates</span>(.)[, <span class="dv">2</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb24-18"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-18" tabindex="-1"></a>      <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-19"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-19" tabindex="-1"></a>      <span class="fu">as.data.frame</span>()</span>
<span id="cb24-20"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-20" tabindex="-1"></a></span>
<span id="cb24-21"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-21" tabindex="-1"></a>    main_data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(main_data,shape_data,<span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Year&quot;</span>,<span class="st">&quot;X&quot;</span>,<span class="st">&quot;Y&quot;</span>,<span class="st">&quot;Crop&quot;</span>,<span class="st">&quot;Yield&quot;</span>))</span>
<span id="cb24-22"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-22" tabindex="-1"></a>  }</span>
<span id="cb24-23"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-23" tabindex="-1"></a>}</span>
<span id="cb24-24"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-24" tabindex="-1"></a></span>
<span id="cb24-25"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-25" tabindex="-1"></a>main_data <span class="ot">&lt;-</span> main_data <span class="sc">%&gt;%</span> </span>
<span id="cb24-26"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Crop, Year, Yield, X,Y, <span class="fu">starts_with</span>(<span class="st">&quot;P&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-27"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-27" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Crop =</span> Crop)</span>
<span id="cb24-28"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb24-28" tabindex="-1"></a><span class="fu">names</span>(main_data)</span></code></pre></div>
<pre><code>## [1] &quot;Crop&quot;      &quot;Year&quot;      &quot;Yield&quot;     &quot;X&quot;         &quot;Y&quot;         &quot;P_3_GCV&quot;  
## [7] &quot;Peak_GCVI&quot; &quot;P_30_GC&quot;   &quot;geometry&quot;</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb26-1" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">write_sf</span>(main_data, <span class="fu">paste0</span>(<span class="st">&quot;1_Data/2_Spatial_Layer/5_VI_YM_df/&quot;</span>,FIELD_TO_CLEAN,<span class="st">&quot;.shp&quot;</span>))</span>
<span id="cb26-2"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb26-2" tabindex="-1"></a></span>
<span id="cb26-3"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb26-3" tabindex="-1"></a><span class="co"># Check the final output</span></span>
<span id="cb26-4"><a href="clean-yield-monitor-data-merge-with-satellite-data.html#cb26-4" tabindex="-1"></a><span class="co">#print(main_data)</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="retrieve-satellite-data.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/2_Clean_YM.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
